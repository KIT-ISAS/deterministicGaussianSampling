name: Build Windows C++ Project

on:
    push:
        branches:
            - "**"

jobs:
    build-windows:
        runs-on: windows-latest
        env:
            BUILD_DIR: build
            ARTIFACT_DIR: artifacts
            CC: C:/ProgramData/mingw64/mingw64/bin/gcc.exe
            CXX: C:/ProgramData/mingw64/mingw64/bin/g++.exe

        steps:
            # checkout code
            - name: Checkout repository
              uses: actions/checkout@v3

            # cache MinGW installation
            - name: Cache MinGW
              id: cache-mingw
              uses: actions/cache@v4
              with:
                  path: C:\ProgramData\mingw64\mingw64\bin
                  key: mingw-${{ runner.os }}-cache
                  restore-keys: |
                      mingw-${{ runner.os }}-

            # install MinGW via Chocolatey
            - name: Install MinGW
              if: steps.cache-mingw.outputs.cache-hit != 'true'
              run: choco install mingw -y --no-progress

            # add MinGW to PATH
            - name: Add MinGW to PATH
              run: echo "C:\ProgramData\mingw64\mingw64\bin" >> $GITHUB_PATH

            # cache vcpkg packages
            - name: Cache vcpkg
              id: cache-vcpkg
              uses: actions/cache@v4
              with:
                  path: |
                      vcpkg/installed
                      vcpkg/packages
                  key: vcpkg-${{ runner.os }}-cache
                  restore-keys: |
                      vcpkg-${{ runner.os }}-

            # install vcpkg for dependencies
            - name: Install dependencies
              if: steps.cache-vcpkg.outputs.cache-hit != 'true'
              run: |
                  if (-not (Test-Path vcpkg)) {
                    git clone https://github.com/microsoft/vcpkg.git
                    .\vcpkg\bootstrap-vcpkg.bat
                  }
                  .\vcpkg\vcpkg install gsl:x64-mingw-static gsl:x64-mingw-dynamic gtest:x64-mingw-static benchmark:x64-mingw-static

            # configure CMake for your project
            - name: Configure CMake
              run: |
                  mkdir %BUILD_DIR%
                  cd %BUILD_DIR%
                  cmake .. -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH="../vcpkg/installed/x64-mingw-static;../vcpkg/installed/x64-mingw-dynamic" -DENABLE_OPENMP=ON

            # build project
            - name: Build Project
              run: |
                  cd %BUILD_DIR%
                  cmake --build . --config Release

            # collect binaries and shared libraries
            - name: Prepare artifact folder
              run: |
                  mkdir %ARTIFACT_DIR%
                  # Copy main binaries
                  copy %BUILD_DIR%\Release\*.exe %ARTIFACT_DIR%\
                  copy %BUILD_DIR%\Release\*.dll %ARTIFACT_DIR%\
                  # Copy dependencies (.dll from vcpkg)
                  xcopy /Y /S .\vcpkg\installed\x64-windows\bin\*.dll %ARTIFACT_DIR%\

            # upload artifacts
            - name: Upload Artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: windows-binaries
                  path: \%ARTIFACT_DIR%\
