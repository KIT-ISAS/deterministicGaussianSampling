name: Build Windows C++ Project

on:
    push:
        branches:
            - "**"

jobs:
    build-windows:
        runs-on: windows-latest
        env:
            BUILD_DIR: build
            ARTIFACT_DIR: artifacts
            CC: C:/ProgramData/mingw64/mingw64/bin/gcc.exe
            CXX: C:/ProgramData/mingw64/mingw64/bin/g++.exe

        steps:
            # checkout code
            - name: Checkout repository
              uses: actions/checkout@v3

            # install MinGW via Chocolatey
            - name: Install MinGW
              run: choco install mingw -y --no-progress

            # add MinGW to PATH
            - name: Add MinGW to PATH
              run: echo "C:\ProgramData\mingw64\mingw64\bin" >> $GITHUB_PATH

            # cache vcpkg packages
            - name: Cache vcpkg
              id: cache-vcpkg
              uses: actions/cache@v4
              with:
                  path: |
                      vcpkg/installed
                      vcpkg/packages
                  key: vcpkg-${{ runner.os }}-cache
                  restore-keys: |
                      vcpkg-${{ runner.os }}-

            # install vcpkg for dependencies
            - name: Install dependencies
              if: steps.cache-vcpkg.outputs.cache-hit != 'true'
              run: |
                  if (-not (Test-Path vcpkg)) {
                    git clone https://github.com/microsoft/vcpkg.git
                    .\vcpkg\bootstrap-vcpkg.bat
                  }
                  .\vcpkg\vcpkg install gsl:x64-mingw-static gsl:x64-mingw-dynamic gtest:x64-mingw-static benchmark:x64-mingw-static

            # configure CMake for your project
            - name: Configure CMake
              shell: pwsh
              run: |
                  # create the build directory
                  if (-not (Test-Path $env:BUILD_DIR)) {
                  New-Item -ItemType Directory -Path $env:BUILD_DIR
                  }

                  # change to build directory
                  Set-Location $env:BUILD_DIR

                  # get libgomp path
                  $GOMP_LIB = & "$env:CC" -print-file-name=libgomp.a

                  # CMake Configuration
                  cmake .. -G "MinGW Makefiles" `
                  -DCMAKE_BUILD_TYPE=Release `
                  -DCMAKE_PREFIX_PATH="../vcpkg/installed/x64-mingw-static;../vcpkg/installed/x64-mingw-dynamic" `
                  -DOpenMP_C_FLAGS="-fopenmp" `
                  -DOpenMP_C_LIB_NAMES="gomp" `
                  -DOpenMP_CXX_FLAGS="-fopenmp" `
                  -DOpenMP_CXX_LIB_NAMES="gomp" `
                  -DOpenMP_gomp_LIBRARY="$GOMP_LIB"

            # build project
            - name: Build Project
              shell: pwsh
              run: |
                  Set-Location $env:BUILD_DIR
                  cmake --build . --config Release

            # prepare and upload artifacts
            - name: prepare artifact folder
              shell: pwsh
              run: |
                  # create artifact folder
                  New-Item -ItemType Directory -Force -Path $env:ARTIFACT_DIR

                  # copy main binaries and DLLs
                  Get-ChildItem -Path $env:BUILD_DIR -Include *.exe, *.dll, *.dll.a -Recurse | 
                      ForEach-Object { Copy-Item $_.FullName -Destination $env:ARTIFACT_DIR -Force }

                  # copy vcpkg dynamic DLL dependencies
                  Get-ChildItem -Path ".\vcpkg\installed\x64-mingw-dynamic\bin" -Filter *.dll -Recurse | 
                      ForEach-Object { Copy-Item $_.FullName -Destination $env:ARTIFACT_DIR -Force }

            - name: upload artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: windows-binaries
                  path: ${{ env.ARTIFACT_DIR }}
