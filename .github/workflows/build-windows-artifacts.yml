name: Build Windows C++ Project

on:
    push:
        branches:
            - "**"

jobs:
    build-windows:
        runs-on: windows-latest
        env:
            BUILD_DIR: build
            ARTIFACT_DIR: artifacts
            CC: C:/tools/mingw64/bin/gcc.exe
            CXX: C:/tools/mingw64/bin/g++.exe

        steps:
            # checkout code
            - name: Checkout repository
              uses: actions/checkout@v3

            # install MinGW via Chocolatey
            - name: Install MinGW
              run: choco install mingw -y --no-progress

            # add MinGW to PATH
            - name: Add MinGW to PATH
              run: echo "C:\tools\mingw64\bin" >> $GITHUB_PATH

            # cache vcpkg packages
            - name: Cache vcpkg packages
              uses: actions/cache@v4
              with:
                  path: |
                      ./vcpkg/installed
                      ./vcpkg/packages
                  key: vcpkg-${{ runner.os }}-mingw
                  restore-keys: |
                      vcpkg-${{ runner.os }}-

            # install vcpkg for dependencies
            - name: Setup vcpkg
              run: |
                  git clone https://github.com/microsoft/vcpkg.git
                  .\vcpkg\bootstrap-vcpkg.bat

            # install dependencies via vcpkg (shared libs)
            - name: Install dependencies
              run: |
                  .\vcpkg\vcpkg install gsl:x64-mingw-static gsl:x64-mingw-dynamic gtest:x64-mingw-static benchmark:x64-mingw-static

            # configure CMake for your project
            - name: Configure CMake
              run: |
                  mkdir %BUILD_DIR%
                  cd %BUILD_DIR%
                  cmake .. -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=..\vcpkg\scripts\buildsystems\vcpkg.cmake -DENABLE_OPENMP=ON

            # build project
            - name: Build Project
              run: |
                  cd %BUILD_DIR%
                  cmake --build . --config Release

            # collect binaries and shared libraries
            - name: Prepare artifact folder
              run: |
                  mkdir %ARTIFACT_DIR%
                  # Copy main binaries
                  copy %BUILD_DIR%\Release\*.exe %ARTIFACT_DIR%\
                  copy %BUILD_DIR%\Release\*.dll %ARTIFACT_DIR%\
                  # Copy dependencies (.dll from vcpkg)
                  xcopy /Y /S .\vcpkg\installed\x64-windows\bin\*.dll %ARTIFACT_DIR%\

            # upload artifacts
            - name: Upload Artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: windows-binaries
                  path: \%ARTIFACT_DIR%\
